<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kamuseo Log In</title>

  <link rel="stylesheet" href="css/stylesheet.css">
  <script src="js/firebase.js" type="module"></script>
</head>

<body class="loginbg">

  <div class="login-container">
    <div class="login-box">
      
      <!-- LOGIN FORM -->
      <div id="loginform" class="loginindex" >
        <img src="css/icons/logo.webp" class="logo">
        <p id="formTitle">Sign In</p>

        <div id="signInMessage" class="messageDiv" style="display:none"></div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="usr-email" placeholder="Enter your email">
        </div>

        <div class="form-group">
          <label>Password</label>
          <input type="password" id="usr-password" placeholder="Enter your password">
        </div>

        <button class="btn-type" id="submitSignIn" type="button">
          Sign In
        </button>

        <p class="link-text">
          Don't have an account?
          <a onclick="switchView('signup')">Sign Up</a>
        </p>
      </div>

      <!-- SIGN UP -->
      <div id="signup" class="loginindex">

        <button class="btn-back" onclick="switchView('signin')">‚Üê Back</button>
        <p id="formTitle">Sign Up</p>

        <div id="signUpMessage" class="messageDiv" style="display:none"></div>

        <div class="form-group">
          <label for="email-sp">Email</label>
          <input type="email" id="email-sp" placeholder="Enter your email" required aria-required="true">
        </div>

        <div class="form-group">
          <label for="fName-sp">First Name</label>
          <input type="text" id="fName-sp" placeholder="Enter your first name" required aria-required="true">
        </div>

        <div class="form-group">
          <label for="lName-sp">Last Name</label>
          <input type="text" id="lName-sp" placeholder="Enter your last name" required aria-required="true">
        </div>

        <div class="form-group">
          <label for="username-sp">Username</label>
          <input type="text" id="username-sp" placeholder="Choose a username" required minlength="3" maxlength="20" aria-required="true">
        </div>

        <div class="form-group">
          <label for="role-sp">I am a:</label>
          <select id="role-sp" name="role" required aria-required="true">
            <option value="">Select your role</option>
            <option value="artist">Artist</option>
            <option value="guest">Guest</option>
          </select>
        </div>

        <div class="form-group">
          <label for="category-sp">Category/Tag</label>
          <input type="text" id="category-sp" placeholder="e.g., Painter, Sculptor, Art Enthusiast" required aria-required="true">
        </div>

        <div class="form-group">
          <label for="password-sp">Password</label>
          <input type="password" id="password-sp" placeholder="Create a password" required minlength="6" aria-required="true">
        </div>

        <div class="form-group">
          <label for="confirm-password-sp">Confirm Password</label>
          <input type="password" id="confirm-password-sp" placeholder="Confirm your password" required minlength="6" aria-required="true">
        </div>

        <button class="btn-type" id="submitSignUp" type="button">
          Sign Up
        </button>

      </div>
      
    </div>
  </div>

  <script>
    // Firebase Auth and Firestore are loaded from firebase.js
    // Supabase is used ONLY for file storage
    
    const loginform = document.getElementById("loginform");
    const signup = document.getElementById("signup");
    const formTitle = document.getElementById("formTitle");

    function hideAll() {
      loginform.style.display = "none";
      signup.style.display = "none";
    }

    function switchView(view) {
      hideAll();

      if (view === "signin") {
        loginform.style.display = "block";
      }
      else {
        signup.style.display = "block";
      }
    }

    // Password match validation for signup form
    const submitSignUp = document.getElementById("submitSignUp");
    if (submitSignUp) {
      submitSignUp.addEventListener("click", async function(event) {
        const password = document.getElementById("password-sp").value;
        const confirmPassword = document.getElementById("confirm-password-sp").value;
        const signUpMessage = document.getElementById("signUpMessage");

        if (password !== confirmPassword) {
          event.preventDefault();
          signUpMessage.textContent = "Passwords do not match. Please try again.";
          signUpMessage.style.display = "block";
          signUpMessage.style.color = "#ff4444";
          return false;
        }
        signUpMessage.style.display = "none";
        
        // Firebase Sign Up
        event.preventDefault();
        await handleFirebaseSignUp();
      });
    }
    
    // Firebase Sign In handler
    const submitSignIn = document.getElementById("submitSignIn");
    if (submitSignIn) {
      submitSignIn.addEventListener("click", async function(event) {
        event.preventDefault();
        await handleFirebaseSignIn();
      });
    }
    
    // Firebase Sign Up function
    async function handleFirebaseSignUp() {
      const email = document.getElementById("email-sp").value;
      const password = document.getElementById("password-sp").value;
      const fName = document.getElementById("fName-sp").value;
      const lName = document.getElementById("lName-sp").value;
      const username = document.getElementById("username-sp").value;
      const role = document.getElementById("role-sp").value || 'guest';
      const category = document.getElementById("category-sp").value;
      const signUpMessage = document.getElementById("signUpMessage");
      
      // Validate role
      if (!role || role === '') {
        signUpMessage.textContent = 'Please select a role';
        signUpMessage.style.display = 'block';
        signUpMessage.style.color = '#ff4444';
        return;
      }
      
      try {
        // Create user with Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Save user profile to Firestore
        await setDoc(doc(db, 'users', user.uid), {
          email: email,
          firstName: fName,
          lastName: lName,
          username: username,
          role: role,
          category: category,
          createdAt: new Date().toISOString()
        });
        
        signUpMessage.textContent = 'Account Created Successfully';
        signUpMessage.style.display = 'block';
        signUpMessage.style.color = '#44ff44';
        
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1500);
        
      } catch (error) {
        console.error('Sign up error:', error);
        let errorMessage = 'Sign up failed';
        
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'Email Address Already Exists';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'Password should be at least 6 characters';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Invalid email address';
        } else {
          errorMessage = error.message;
        }
        
        signUpMessage.textContent = errorMessage;
        signUpMessage.style.display = 'block';
        signUpMessage.style.color = '#ff4444';
      }
    }
    
    // Firebase Sign In function
    async function handleFirebaseSignIn() {
      const email = document.getElementById("usr-email").value;
      const password = document.getElementById("usr-password").value;
      const signInMessage = document.getElementById("signInMessage");
      
      try {
        // Sign in with Firebase Auth
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        signInMessage.textContent = 'Login is successful';
        signInMessage.style.display = 'block';
        signInMessage.style.color = '#44ff44';
        
        localStorage.setItem('loggedInUserId', user.uid);
        
        setTimeout(() => {
          window.location.href = 'home2.html';
        }, 1000);
        
      } catch (error) {
        console.error('Sign in error:', error);
        let errorMessage = 'Login failed';
        
        if (error.code === 'auth/invalid-credential' || error.code === 'auth/invalid-email' || error.code === 'auth/wrong-password') {
          errorMessage = 'Incorrect Email or Password';
        } else if (error.code === 'auth/user-not-found') {
          errorMessage = 'Account Does Not Exist';
        } else {
          errorMessage = error.message;
        }
        
        signInMessage.textContent = errorMessage;
        signInMessage.style.display = 'block';
        signInMessage.style.color = '#ff4444';
      }
    }

    // Default view
    switchView("signin");
  </script>

</body>
</html>
